<page-header title="{{ isEditMode ? 'Edit Item' : 'New Item' }}" [nav]="['home', 'request', 'new']"></page-header>

<div fxLayout="row wrap" class="matero-row">
    <div fxFlex="100" fxFlex.lt-sm="100" class="matero-col">
        <mat-card>
            <mat-card-title>{{ isEditMode ? "Edit Request" : "New Request" }}
            </mat-card-title>

            <form [formGroup]="requestForm" (submit)="onFormSubmit($event)" class="form-field-full">
                <div fxLayout="row wrap" fxLayoutGap="8px grid">
                    <div fxFlex="30" fxFlex.lt-sm="100">
                        <mat-form-field>
                            <mat-label>Order Type</mat-label>
                            <mat-select placeholder="Order Type" required formControlName="requestOrderType">
                                <mat-option *ngFor="let type of requestType" [value]="type.value">{{ type.lable }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('requestOrderType').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div fxFlex="70" fxFlex.lt-sm="100" *ngIf="requestForm.get('requestOrderType').value">
                        <mat-radio-group aria-label="Select request type" formControlName="selectRequestType">
                            <mat-radio-button value="send">Send</mat-radio-button>
                            &nbsp; &nbsp;
                            <mat-radio-button value="recieve">Recieve</mat-radio-button>
                        </mat-radio-group>
                    </div>
                    <div fxFlex="50" fxFlex.lt-sm="100" *ngIf="requestForm.get('selectRequestType').value">
                        <mat-form-field>
                            <mat-label>Source Role</mat-label>
                            <mat-select placeholder="Source Role"
                                (selectionChange)="filterRoleChanged('searchBySorceRoleName')"
                                formControlName="searchBySorceRoleName">
                                <mat-option *ngFor="let sourceRole of filterRoleList" [value]="sourceRole._id">
                                    {{ sourceRole.name }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('searchBySorceRoleName').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div fxFlex="50" fxFlex.lt-sm="100" *ngIf="requestForm.get('selectRequestType').value">
                        <mat-form-field>
                            <mat-label>Source User</mat-label>
                            <mat-select placeholder="User" formControlName="sourceUserId">
                                <mat-option *ngFor="let sourceUser of sourceUserList" [value]="sourceUser._id">
                                    {{ sourceUser.first_name }}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('sourceUserId').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div fxFlex="50" fxFlex.lt-sm="100" *ngIf="requestForm.get('selectRequestType').value && requestForm.get('searchBySorceRoleName').value">
                        <mat-form-field>
                            <mat-label>Destination Role</mat-label>
                            <mat-select placeholder="User Role"
                                (selectionChange)="filterRoleChanged('destinationRoleName')"
                                formControlName="destinationRoleName">
                                <mat-option *ngFor="let destionRole of destinationRoleList" [value]="destionRole._id">
                                    {{ destionRole.name | titlecase}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('destinationRoleName').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <div fxFlex="50" fxFlex.lt-sm="100" *ngIf="requestForm.get('selectRequestType').value && requestForm.get('searchBySorceRoleName').value">
                        <mat-form-field>
                            <mat-label>Destination User</mat-label>
                            <mat-select placeholder="User" formControlName="destinationUserId">
                                <mat-option *ngFor="let destinationUser of destinationUserList"
                                    [value]="destinationUser._id">{{ destinationUser.first_name | titlecase}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('destinationUserId').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div fxFlex="50" fxFlex.lt-sm="100"
                        *ngIf="requestForm.get('requestOrderType').value === 'PURCHASE_ORDER' && requestForm.get('selectRequestType').value && requestForm.get('searchBySorceRoleName').value">
                        <mat-form-field>
                            <mat-label>Supplier User</mat-label>
                            <mat-select placeholder="User" formControlName="supplierUserId">
                                <mat-option *ngFor="let sourceUser of supplierList" [value]="sourceUser._id">
                                    {{ sourceUser.first_name | titlecase}}
                                </mat-option>
                            </mat-select>
                            <mat-error *ngIf="requestForm.get('sourceUserId').invalid">
                                {{ "validations.required" | translate }}
                            </mat-error>
                        </mat-form-field>
                    </div>
                    <div fxFlex="{{requestForm.get('requestOrderType').value === 'PURCHASE_ORDER'?50:100}}"
                        fxFlex.lt-sm="100">
                    </div>
                    <div fxFlex="50" fxFlex.lt-sm="100" style="padding-right: 20px;" *ngIf="requestForm.get('selectRequestType').value && requestForm.get('searchBySorceRoleName').value">
                        <mat-card-title>Items
                        </mat-card-title>
                        <div class="">
                            <table mat-table [dataSource]="dataSource" matSort style="width: 100%;">
                                <!-- position Column -->
                                <ng-container matColumnDef="action">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Controls</th>
                                    <td mat-cell *matCellDef="let row; let i = index">
                                        <mat-grid-list cols="3" rowHeight="50px">
                                            <mat-grid-tile>
                                                <button mat-icon-button aria-label="Add" (click)="addCartItem(row,i)">
                                                    <mat-icon color="accent">add_circle_outline</mat-icon>
                                                </button>
                                            </mat-grid-tile>
                                        </mat-grid-list>
                                    </td>
                                </ng-container>

                                <!-- Name Column -->
                                <ng-container matColumnDef="itemName">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Item Name</th>
                                    <td mat-cell style="max-width: 100px" *matCellDef="let row">
                                        {{ row.name | titlecase}}
                                    </td>
                                </ng-container>
                                <!-- category -->
                                <ng-container matColumnDef="price">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Price</th>
                                    <td mat-cell *matCellDef="let row">
                                        {{row.price | currency:'INR'}}
                                        <!-- <input type="number" [ngModelOptions]="{ standalone: true }"
                                            (change)="changePosition(row)" style="max-width: 50px"
                                            [(ngModel)]="row.price" /> -->
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                            </table>

                            <mat-paginator (page)="pageEvent($event)" [length]="pageDetails.totalRecords"
                                [pageSize]="pageDetails.itemsPerPage" [pageSizeOptions]="[5, 10, 25]"></mat-paginator>
                        </div>
                    </div>

                    <div fxFlex="50" fxFlex.lt-sm="100" *ngIf="cartItemList.length > 0">
                        <mat-card-title> Cart Details
                        </mat-card-title>
                        <div class="">
                            <table mat-table [dataSource]="dataSourceCart" matSort style="width: 100%;">
                                <ng-container matColumnDef="action">
                                    <!-- <th mat-header-cell *matHeaderCellDef mat-sort-header>Controls</th> -->
                                    <td mat-cell *matCellDef="let row; let i = index">
                                        <button mat-icon-button aria-label="Add" (click)="deleteICartItem(row,i)">
                                            <mat-icon color="accent">delete_outline</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <!-- Name Column -->
                                <ng-container matColumnDef="itemName">
                                    <!-- <th mat-header-cell *matHeaderCellDef mat-sort-header>Item Name</th> -->
                                    <td mat-cell style="max-width: 100px" *matCellDef="let row">
                                        {{ row.name | titlecase}}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="price">
                                    <!-- <th mat-header-cell *matHeaderCellDef mat-sort-header>Quantity</th> -->

                                    <td mat-cell *matCellDef="let row">
                                        {{(row.price * (row.quantity == 0 ? 1 :row.quantity )) | currency:'INR'}}
                                        <!-- <input type="number"
                                            [ngModelOptions]="{ standalone: true }" (change)="changePosition(row)"
                                            style="max-width: 50px" [(ngModel)]="row.price" /> -->
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="quantity">
                                    <!-- <th mat-header-cell *matHeaderCellDef mat-sort-header>Price</th> -->
                                    <td mat-cell *matCellDef="let row; let i = index;" class="quanmob" style="width: 26%;">
                                        <button type="button" mat-icon-button aria-label="Add" (click)="addQuantity(i)">
                                            <mat-icon color="accent">add_circle_outline</mat-icon>
                                        </button><input type="text" [ngModelOptions]="{ standalone: true }"
                                            (change)="changeQuantity(row,i)" style="max-width: 50px"
                                            [(ngModel)]="row.quantity" /> 
                                            <button type="button" mat-icon-button aria-label="Add"
                                            (click)="removeQuantity(i)">
                                            <mat-icon color="accent">remove_circle_outline</mat-icon>
                                        </button>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="unit">
                                    <!-- <th mat-header-cell *matHeaderCellDef>Unit</th> -->
                                    <!-- <form> -->
                                        <td mat-cell *matCellDef="let row; let i = index;">
                                            <mat-select style="max-width: 80px;" placeholder="Unit"
                                                (selectionChange)="updateUnit(row,i)"
                                                [ngModelOptions]="{ standalone: true }" [(ngModel)]="row.unit"
                                                name="unit"
                                                *ngIf="requestForm.get('requestOrderType').value === 'PURCHASE_ORDER'">
                                                <mat-option *ngFor="let unit of unitList" [value]="unit._id">{{
                                        unit.name
                                      }}</mat-option>
                                            </mat-select>
                                            <span
                                                *ngIf="requestForm.get('requestOrderType').value === 'TRANSFER_ORDER'">
                                                {{row.unit_id.name | titlecase}}
                                            </span>
                                        </td>
                                    <!-- </form> -->
                                </ng-container>
                                <ng-container matColumnDef="title">
                                    <td mat-footer-cell *matFooterCellDef="let row">
                                        <b> Total : </b>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="blankCell">
                                    <td mat-footer-cell *matFooterCellDef>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="total">
                                    <td mat-footer-cell *matFooterCellDef>
                                        <b>{{ getTotal() | currency: 'INR' }} </b>
                                    </td>
                                </ng-container>
                                <!-- <tr mat-header-row *matHeaderRowDef="cartDisplayedColumns"></tr> -->
                                <tr mat-row *matRowDef="let row; columns: cartDisplayedColumns"></tr>
                                <tr mat-footer-row
                                    *matFooterRowDef="['title', 'blankCell', 'blankCell', 'total']; sticky: true"> </tr>
                            </table>

                            <!-- <mat-paginator (page)="pageEvent($event)" [length]="pageDetails.totalRecords"
                                [pageSize]="pageDetails.itemsPerPage" [pageSizeOptions]="[5, 10, 25]"></mat-paginator> -->
                        </div>
                    </div>
                </div>

                <button mat-raised-button color="primary" type="submit" style="margin-right: 5px" class="m-t-8">
                    Save
                </button>
                <button mat-raised-button type="button" [routerLink]="['/items']" class="m-t-8">
                    Back
                </button>
            </form>
        </mat-card>
    </div>
</div>